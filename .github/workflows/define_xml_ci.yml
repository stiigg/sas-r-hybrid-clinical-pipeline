name: Define-XML Generation CI

on:
  push:
    branches: [ main, develop, feature/pinnacle21-define-xml-automation ]
    paths:
      - 'sdtm/specs/**'
      - 'regulatory_submission/define_xml/**'
      - '.github/workflows/define_xml_ci.yml'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  generate-define-xml-metadata:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.3.0'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxml2-dev libcurl4-openssl-dev libssl-dev
    
    - name: Cache R packages
      uses: actions/cache@v3
      with:
        path: ${{ env.R_LIBS_USER }}
        key: ${{ runner.os }}-r-${{ hashFiles('DESCRIPTION') }}
        restore-keys: |
          ${{ runner.os }}-r-
    
    - name: Install R packages
      run: |
        Rscript -e 'install.packages(c("yaml", "xml2", "dplyr", "readr", "readxl", "xportr", "haven", "purrr", "tidyr", "janitor", "cli", "logger", "here", "writexl"), repos="https://cloud.r-project.org")'
    
    - name: Check SDTM specs exist
      run: |
        echo "Checking for SDTM specification files..."
        if [ -d "sdtm/specs" ]; then
          echo "✓ SDTM specs directory exists"
          ls -lh sdtm/specs/*.csv || echo "No CSV spec files found"
        else
          echo "⚠ SDTM specs directory not found"
        fi
    
    - name: Generate demo SDTM datasets
      run: |
        mkdir -p sdtm/data
        echo "Creating demo DM dataset for CI testing..."
        Rscript -e '
          library(haven)
          demo_dm <- data.frame(
            STUDYID = rep("STUDY001", 5),
            DOMAIN = rep("DM", 5),
            USUBJID = paste0("STUDY001-001-", sprintf("%03d", 1:5)),
            SUBJID = sprintf("%03d", 1:5),
            RFSTDTC = "2024-01-15",
            SITEID = "001",
            AGE = c(55, 62, 48, 71, 59),
            AGEU = rep("YEARS", 5),
            SEX = c("M", "F", "M", "F", "M"),
            RACE = rep("WHITE", 5),
            ARMCD = rep("TRT", 5),
            ARM = rep("Treatment", 5),
            COUNTRY = rep("USA", 5),
            stringsAsFactors = FALSE
          )
          haven::write_sas(demo_dm, "sdtm/data/dm.sas7bdat")
          cat("✓ Demo DM dataset created\n")
        '
      continue-on-error: true
    
    - name: Generate XPT files (Phase 1)
      run: |
        echo "Running Phase 1: XPT generation..."
        Rscript regulatory_submission/define_xml/scripts/01_extract_pinnacle21_metadata.R || echo "Phase 1 completed with warnings"
      continue-on-error: true
    
    - name: Validate XPT generation
      run: |
        echo "Checking generated XPT files..."
        if [ -d "regulatory_submission/define_xml/metadata/xpt_files" ]; then
          echo "✓ XPT directory created"
          ls -lh regulatory_submission/define_xml/metadata/xpt_files/*.xpt || echo "No XPT files generated"
          xpt_count=$(ls regulatory_submission/define_xml/metadata/xpt_files/*.xpt 2>/dev/null | wc -l)
          echo "XPT files generated: $xpt_count"
        else
          echo "⚠ XPT directory not created"
        fi
    
    - name: Check metadata artifacts
      run: |
        echo "Checking metadata artifacts..."
        if [ -f "regulatory_submission/define_xml/metadata/xpt_manifest.csv" ]; then
          echo "✓ XPT manifest created"
          cat regulatory_submission/define_xml/metadata/xpt_manifest.csv
        fi
    
    - name: Upload XPT artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: define-xml-xpt-files
        path: |
          regulatory_submission/define_xml/metadata/xpt_files/*.xpt
          regulatory_submission/define_xml/metadata/*.csv
        retention-days: 30
        if-no-files-found: warn
    
    - name: Generate CI summary
      if: always()
      run: |
        echo "## Define-XML Generation CI Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- R Version: 4.3.0" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### XPT Generation Results" >> $GITHUB_STEP_SUMMARY
        if [ -d "regulatory_submission/define_xml/metadata/xpt_files" ]; then
          xpt_count=$(ls regulatory_submission/define_xml/metadata/xpt_files/*.xpt 2>/dev/null | wc -l)
          echo "✅ XPT files generated: $xpt_count" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Files Created" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh regulatory_submission/define_xml/metadata/xpt_files/*.xpt 2>/dev/null || echo "None" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ No XPT files generated" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Complete Phase 1 by generating Pinnacle 21 spec manually" >> $GITHUB_STEP_SUMMARY
        echo "2. Run Phase 2: Metadata enrichment from SDTM specs" >> $GITHUB_STEP_SUMMARY
        echo "3. Run Phase 3: Define-XML v2.1 generation" >> $GITHUB_STEP_SUMMARY
        echo "4. Validate with Pinnacle 21 Community" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Manual Workflow" >> $GITHUB_STEP_SUMMARY
        echo 'Run locally:' >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo 'Rscript regulatory_submission/define_xml/generate_define_sdtm.R' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
